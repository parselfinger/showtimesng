---
import { formatShowtime, formatDate, groupShowtimesByDate, slugify } from '../lib/utils';

interface Props {
  showtimes: any[];
  showCinema?: boolean;
  showMovie?: boolean;
}

const { showtimes, showCinema = false, showMovie = false } = Astro.props;

// Group by date
const grouped = groupShowtimesByDate(showtimes);

// Helper to group by cinema
function groupByCinema(times: any[]) {
  const result: Record<string, { cinema: any; times: any[] }> = {};
  for (const st of times) {
    if (!result[st.cinema.id]) {
      result[st.cinema.id] = { cinema: st.cinema, times: [] };
    }
    result[st.cinema.id].times.push(st);
  }
  return Object.values(result);
}

// Helper to group by movie
function groupByMovie(times: any[]) {
  const result: Record<string, { movie: any; times: any[] }> = {};
  for (const st of times) {
    if (!result[st.movie.id]) {
      result[st.movie.id] = { movie: st.movie, times: [] };
    }
    result[st.movie.id].times.push(st);
  }
  return Object.values(result);
}
---

<div class="space-y-6">
  {Object.entries(grouped).map(([date, times]) => (
    <div>
      <h4 class="text-lg font-semibold mb-3 text-accent">
        {formatDate((times as any[])[0].start_time)}
      </h4>
      <div class="space-y-3">
        {showCinema && groupByCinema(times as any[]).map(({ cinema, times: cinemaTimes }) => (
          <div class="bg-secondary rounded-lg p-4">
            <a href={`/cinemas/${cinema.id}-${slugify(cinema.name)}`} class="font-medium hover:text-accent">
              {cinema.name}
            </a>
            {(cinema.verbose_location || cinema.location) && (
              <p class="text-sm text-gray-400">{cinema.verbose_location || cinema.location}</p>
            )}
            <div class="mt-3 flex flex-wrap gap-2">
              {cinemaTimes.map((st: any) => (
                st.movie_url ? (
                  <a
                    href={st.movie_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="px-3 py-2 bg-primary rounded text-sm hover:bg-accent transition-colors"
                  >
                    {formatShowtime(st.start_time)}
                    {st.screen_type !== '2D' && <span class="ml-1 text-xs">({st.screen_type})</span>}
                  </a>
                ) : (
                  <span class="px-3 py-2 bg-primary rounded text-sm">
                    {formatShowtime(st.start_time)}
                    {st.screen_type !== '2D' && <span class="ml-1 text-xs">({st.screen_type})</span>}
                  </span>
                )
              ))}
            </div>
          </div>
        ))}

        {showMovie && groupByMovie(times as any[]).map(({ movie, times: movieTimes }) => (
          <div class="bg-secondary rounded-lg p-4">
            <a href={`/movies/${movie.id}-${slugify(movie.title)}`} class="font-medium hover:text-accent">
              {movie.title}
            </a>
            <div class="mt-3 flex flex-wrap gap-2">
              {movieTimes.map((st: any) => (
                st.movie_url ? (
                  <a
                    href={st.movie_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="px-3 py-2 bg-primary rounded text-sm hover:bg-accent transition-colors"
                  >
                    {formatShowtime(st.start_time)}
                    {st.screen_type !== '2D' && <span class="ml-1 text-xs">({st.screen_type})</span>}
                  </a>
                ) : (
                  <span class="px-3 py-2 bg-primary rounded text-sm">
                    {formatShowtime(st.start_time)}
                    {st.screen_type !== '2D' && <span class="ml-1 text-xs">({st.screen_type})</span>}
                  </span>
                )
              ))}
            </div>
          </div>
        ))}

        {!showCinema && !showMovie && (
          <div class="flex flex-wrap gap-2">
            {(times as any[]).map((st: any) => (
              st.movie_url ? (
                <a
                  href={st.movie_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="px-3 py-2 bg-secondary rounded text-sm hover:bg-accent transition-colors"
                >
                  {formatShowtime(st.start_time)}
                  {st.screen_type !== '2D' && <span class="ml-1 text-xs">({st.screen_type})</span>}
                </a>
              ) : (
                <span class="px-3 py-2 bg-secondary rounded text-sm">
                  {formatShowtime(st.start_time)}
                  {st.screen_type !== '2D' && <span class="ml-1 text-xs">({st.screen_type})</span>}
                </span>
              )
            ))}
          </div>
        )}
      </div>
    </div>
  ))}
</div>
